# GEMINI.md

## Project Overview

This repository, `kipos`, is a NixOS configuration management project. It uses Nix Flakes to define and manage the configurations of multiple machines, including both NixOS and macOS (via nix-darwin). The project is structured to support per-machine configurations, shared profiles, and automated testing of the configurations. It also integrates with `sops-nix` for secret management and `disko` for declarative disk partitioning.

The core technologies used are:
- **Nix:** The purely functional package manager and language used to define system configurations.
- **Nix Flakes:** The new, improved interface for Nix that provides better reproducibility and dependency management.
- **NixOS:** The Linux distribution built on top of the Nix package manager.
- **nix-darwin:** A project that allows you to manage macOS configurations using Nix.
- **sops-nix:** For managing secrets in a secure way.
- **disko:** For declarative disk partitioning.

The project is structured as follows:
- `flake.nix`: The main entry point for the Nix Flake, defining inputs, outputs, and system configurations.
- `machines/`: Contains the specific configurations for each machine.
- `profiles/`: Contains shared configuration profiles that can be included in multiple machine configurations.
- `tests/`: Contains NixOS tests to verify the correctness of the machine configurations.

## Building and Running

### Building a Configuration

To build a specific machine configuration, you can use the `nixos-rebuild` command with the appropriate flake output. For example, to build the `test` VM:

```shell
nixos-rebuild build-vm --flake .#test
```

### Running a Test VM

To run a test VM locally, you can use the `run-nixos-vm` script that is generated by the `nixos-rebuild build-vm` command.

```shell
QEMU_NET_OPTS="hostfwd=tcp::2221-:22" result/bin/run-nixos-vm
```

You can then SSH into the running VM:

```shell
ssh -oUserKnownHostsFile=/dev/null -oStrictHostKeyChecking=no admin@localhost -p 2221
```

To shut down the VM, use `CTRL+a, x`.

### Running Tests

The project includes a suite of tests that can be run using the `nix flake check` command. For example, to run the `hello` test:

```shell
nix flake check .#hello
```

Or to run all checks:

```shell
nix flake check
```

## Development Conventions

- **Formatting:** The project uses `treefmt-nix` with `nixfmt` to ensure consistent formatting of Nix code. You can run the formatter using `nix fmt`.
- **Pre-commit Hooks:** The `.pre-commit-config.yaml` file suggests the use of pre-commit hooks to automate checks before committing code.
- **Secrets:** Secrets are managed using `sops-nix` and are stored in a separate private repository. The `flake.nix` file references this repository as an input.
- **Testing:** The project has a strong emphasis on testing, with a dedicated `tests/` directory and multiple test cases defined in the `flake.nix` file.
